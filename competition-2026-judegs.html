<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yoga Judge Portal</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    /* --- YOGA THEME PALETTE --- */
    :root {
      --primary: #ea580c;       /* Saffron / Burnt Orange */
      --primary-dark: #c2410c;  /* Deep Rust (Hover state) */
      --secondary: #991b1b;     /* Maroon Accent */
      --gold: #d97706;          /* Gold */
      
      /* Warm Backgrounds */
      --bg-gradient: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); 
      --glass: rgba(255, 255, 255, 0.95);
      --glass-border: 1px solid rgba(253, 186, 116, 0.4); 
      
      --shadow: 0 10px 30px -5px rgba(234, 88, 12, 0.15); 
      
      --text-main: #27272a;     /* Dark Grey */
      --text-muted: #71717a;    /* Muted Grey */
      --text-on-primary: #ffffff;
      
      --red-error: #ef4444;
      --green-success: #22c55e;
    }

    /* --- RESET & BASE --- */
    * { box-sizing: border-box; }
    body { 
      margin: 0; font-family: 'Poppins', sans-serif; 
      background: var(--bg-gradient); color: var(--text-main); 
      min-height: 100vh; display: flex; flex-direction: column; align-items: center; 
    }
    .hidden { display: none !important; }

    /* --- LOADER --- */
    #loader { 
      position: fixed; top:0; left:0; width:100%; height:100%; 
      background: rgba(255, 247, 237, 0.95); z-index:9999; 
      display:flex; justify-content:center; align-items:center; flex-direction:column;
      backdrop-filter: blur(8px);
    }
    .spinner {
      border: 4px solid rgba(234, 88, 12, 0.1); border-top: 4px solid var(--primary);
      border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- SYSTEM STATUS PANEL --- */
    #status-panel {
      position: fixed; bottom: 20px; right: 20px;
      background: var(--glass); padding: 15px;
      border-radius: 12px; border: var(--glass-border);
      box-shadow: var(--shadow); font-size: 12px; color: var(--text-muted); 
      width: 180px; backdrop-filter: blur(10px); z-index: 500;
    }
    .status-item { display: flex; justify-content: space-between; margin-bottom: 6px; font-weight: 500;}
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .dot-green { background: var(--green-success); box-shadow: 0 0 8px var(--green-success); }
    .dot-red { background: var(--red-error); box-shadow: 0 0 8px var(--red-error); }
    .dot-yellow { background: var(--gold); }

    /* --- LOGIN SCREEN --- */
    #login-screen { 
      width: 90%; max-width: 380px; margin-top: 10vh;
      background: var(--glass); padding: 40px; 
      border-radius: 20px; border: var(--glass-border); 
      box-shadow: var(--shadow); text-align: center; 
    }
    .logo-img {
      width: 90px; height: 90px; border-radius: 50%; 
      border: 3px solid var(--primary); object-fit: cover;
      margin-bottom: 20px; padding: 4px; background: #fff;
      box-shadow: 0 4px 12px rgba(234, 88, 12, 0.2);
    }
    .input-box { position: relative; margin-bottom: 20px; text-align: left; }
    .input-box i { position: absolute; left: 15px; top: 14px; color: var(--primary); }
    .inp { 
      width: 100%; padding: 14px 14px 14px 45px; 
      border-radius: 10px; border: 1px solid #fed7aa; 
      background: #fff; color: var(--text-main); font-size: 15px; 
      transition: 0.3s;
    }
    .inp:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1); }
    
    .btn-primary { 
      background: var(--primary); color: var(--text-on-primary); 
      font-weight: 600; padding: 14px; width: 100%; 
      border-radius: 10px; font-size: 16px; border:none; 
      cursor: pointer; transition: transform 0.1s, background 0.2s;
      box-shadow: 0 4px 10px rgba(234, 88, 12, 0.3);
    }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-primary:active { transform: scale(0.98); }

    /* --- HEADER --- */
    .app-header { 
      position: fixed; top: 0; left: 0; right: 0; height: 70px; 
      display: flex; justify-content: space-between; align-items: center; 
      padding: 0 20px; background: rgba(255, 255, 255, 0.9); 
      border-bottom: 1px solid #fed7aa; z-index: 100;
      backdrop-filter: blur(10px); box-shadow: 0 2px 15px rgba(0,0,0,0.03);
    }
    .brand { font-size: 18px; font-weight: 700; color: var(--primary-dark); letter-spacing: -0.5px; }
    
    .node-badge { 
      font-size: 12px; color: var(--green-success); 
      margin-right: 15px; display: flex; align-items: center; gap: 6px; 
      background: rgba(34, 197, 94, 0.1); padding: 4px 10px; border-radius: 20px; font-weight: 600;
    }
    
    .profile-btn { 
      background: transparent; border: none; color: var(--text-main); 
      display: flex; align-items: center; gap: 8px; font-size: 14px; 
      font-weight: 600; cursor: pointer; 
    }
    .dropdown-content {
      display: none; position: absolute; right: 20px; top: 65px; 
      background-color: #fff; min-width: 180px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
      border-radius: 12px; overflow: hidden; border: 1px solid #f3f4f6;
    }
    .dropdown-content div { padding: 12px 20px; cursor: pointer; color: var(--text-main); font-size: 14px; }
    .dropdown-content div:hover { background-color: #fff7ed; color: var(--primary); }
    .show { display: block; }

    /* --- TRACK SCREEN --- */
    #track-screen { width: 95%; max-width: 600px; padding-top: 100px; text-align: center; }
    .track-card {
      background: var(--glass); padding: 30px; border-radius: 20px;
      border: var(--glass-border); box-shadow: var(--shadow);
    }
    .track-row { margin-bottom: 20px; text-align: left; }
    .track-row label { display: block; color: var(--text-muted); margin-bottom: 8px; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .track-inp { text-transform: uppercase; font-size: 18px; letter-spacing: 1px; font-weight: 600; color: var(--primary-dark); }

    /* --- SCORING SCREEN --- */
    #scoring-screen { width: 95%; max-width: 1000px; padding-top: 100px; padding-bottom: 60px; }
    
    /* Table Header (Desktop) */
    .table-header { 
      display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; 
      padding: 0 15px; margin-bottom: 10px; display: none; /* Hidden on mobile */
    }
    @media (min-width: 768px) { .table-header { display: grid; } }
    
    .th-cell { color: var(--text-muted); font-size: 12px; font-weight: 700; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; }
    .th-left { text-align: left; }

    /* Student Card Row */
    .score-card { 
      background: var(--glass); border-radius: 16px; border: var(--glass-border); 
      box-shadow: var(--shadow); margin-bottom: 15px; padding: 20px;
      display: flex; flex-direction: column; gap: 15px; /* Mobile Default */
    }

    @media (min-width: 768px) {
      .score-card { 
        display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; 
        align-items: center; gap: 10px; padding: 15px;
      }
    }

    /* Student Info Section */
    .student-details { display: flex; flex-direction: column; gap: 2px; }
    .sd-track { color: var(--primary); font-size: 18px; font-weight: 700; }
    .sd-name { font-size: 16px; font-weight: 600; color: var(--text-main); }
    .sd-coach { font-size: 12px; color: var(--text-muted); background: #f3f4f6; padding: 2px 8px; border-radius: 4px; align-self: flex-start; margin-top: 4px; }

    /* Inputs */
    .input-cell { 
      display: flex; flex-direction: column; align-items: center; 
    }
    .mobile-label { font-size: 11px; color: var(--text-muted); margin-bottom: 5px; font-weight: 600; display: block; }
    @media (min-width: 768px) { .mobile-label { display: none; } } /* Hide label on desktop */

    .score-input { 
      width: 100%; max-width: 80px; padding: 12px; font-size: 18px; text-align: center; 
      background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; 
      color: var(--text-main); font-weight: 600; transition: 0.2s;
    }
    .score-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1); }
    .score-input.error { border-color: var(--red-error); background: #fef2f2; color: var(--red-error); }

    /* Footer */
    .footer { display: flex; gap: 15px; margin-top: 30px; justify-content: center; width: 100%; }
    .btn-out { 
      background: #fff; border: 2px solid var(--primary); color: var(--primary); 
      padding: 14px 24px; border-radius: 10px; font-weight: 600; cursor:pointer; 
      transition: 0.2s;
    }
    .btn-out:hover { background: #fff7ed; }

    /* --- RESPONSIVE ADJUSTMENTS --- */
    @media (max-width: 768px) {
      .score-card { 
        display: grid; 
        grid-template-columns: 1fr 1fr; /* 2 columns for inputs on mobile */
        gap: 15px;
      }
      .student-details { grid-column: span 2; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; margin-bottom: 5px; }
      .footer { flex-direction: column-reverse; }
      .btn-out, .btn-primary { width: 100%; }
    }
  </style>
</head>
<body>

  <div id="loader" class="hidden">
    <div class="spinner"></div>
    <h3 id="loader-txt" style="color:var(--text-main); font-size:16px; font-weight: 600;">Loading System...</h3>
  </div>

  <div id="status-panel">
    <div style="border-bottom:1px solid #fed7aa; margin-bottom:8px; padding-bottom:5px; font-weight:700; color:var(--primary-dark);">SYSTEM HEALTH</div>
    <div class="status-item"><span>Auth Database</span> <div id="stat-auth" class="status-dot dot-yellow"></div></div>
    <div class="status-item"><span>Node 1</span> <div id="stat-n1" class="status-dot dot-yellow"></div></div>
    <div class="status-item"><span>Node 2</span> <div id="stat-n2" class="status-dot dot-yellow"></div></div>
    <div class="status-item"><span>Node 3</span> <div id="stat-n3" class="status-dot dot-yellow"></div></div>
  </div>

  <div id="login-screen">
    <img src="resources\yoga_dp.jpeg" alt="Logo" class="logo-img">
    <h2 style="color:var(--text-main); margin:0 0 5px 0; font-weight:700;">Welcome Judge</h2>
    <p style="color:var(--text-muted); margin:0 0 30px 0; font-size:14px;">Please sign in to access the podium</p>
    
    <div class="input-box">
      <i class="material-icons">person_outline</i>
      <input id="user" class="inp" type="text" placeholder="Username">
    </div>
    <div class="input-box">
      <i class="material-icons">lock_outline</i>
      <input id="pin" class="inp" type="password" placeholder="Access PIN">
    </div>
    
    <button id="login-btn" class="btn-primary" onclick="handleLogin()">SECURE LOGIN</button>
    <div id="login-error" style="color:var(--red-error); margin-top:15px; font-size:13px; font-weight:500; display:none;"></div>
  </div>

  <div id="app-header" class="app-header hidden">
    <div style="display:flex; align-items:center;">
      <div class="brand">YOGA PRO</div>
    </div>
    
    <div style="display:flex; align-items:center;">
      <div class="node-badge"><span class="status-dot dot-green"></span> <span id="active-node-lbl">Online</span></div>
      
      <div class="user-menu" onclick="toggleDropdown()">
        <button class="profile-btn">
          <span id="judge-lbl">Judge</span> 
          <img src="" style="border-radius:50%; border:2px solid var(--primary);" id="header-avatar" width="32" height="32">
          <i class="material-icons" style="font-size:18px;">expand_more</i>
        </button>
        <div id="userDropdown" class="dropdown-content">
          <div onclick="window.location.href='test-portal.html'">
            <i class="material-icons" style="vertical-align:middle; font-size:16px; margin-right:5px; color:var(--primary);">dashboard</i> Dashboard
          </div>
          <div onclick="window.location.reload()" style="border-top:1px solid #f3f4f6; color:var(--red-error);">
             Logout
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="track-screen" class="hidden">
    <div class="track-card">
      <h3 style="color:var(--text-main); margin-bottom:5px; font-weight:700;">Enter Heat Details</h3>
      <p style="color:var(--text-muted); font-size:14px; margin-bottom:30px;">Enter the student track numbers for this heat.</p>
      
      <div class="track-row">
        <label>Student A Track No.</label>
        <input id="track-a" class="inp track-inp" type="text" placeholder="e.g. VT001">
      </div>
      <div class="track-row">
        <label>Student B Track No.</label>
        <input id="track-b" class="inp track-inp" type="text" placeholder="e.g. SJ023">
      </div>
      <div class="track-row">
        <label>Student C Track No.</label>
        <input id="track-c" class="inp track-inp" type="text" placeholder="e.g. MK101">
      </div>

      <button class="btn-primary" onclick="startHeat()" style="margin-top:20px;">FETCH DATA & START</button>
    </div>
  </div>

  <div id="scoring-screen" class="hidden">
    
    <div class="table-header">
      <div class="th-cell th-left">STUDENT INFO</div>
      <div class="th-cell">ASANA 1</div>
      <div class="th-cell">ASANA 2</div>
      <div class="th-cell">ASANA 3</div>
      <div class="th-cell">OPTIONAL</div>
    </div>

    <div id="grid"></div>

    <div class="footer">
      <button class="btn-out" onclick="reset()">CANCEL HEAT</button>
      <button class="btn-primary" onclick="submit()">SUBMIT SCORES</button>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const GIST_URL = "https://gist.githubusercontent.com/Code04Sohan/03f0887af2dc685bf42af056cf878cc8/raw/4c16640dbb14fcc5c59cf7da2224697a326b5e35/judges.json";
    
    const API_POOL = {
      "1": "https://script.google.com/macros/s/AKfycbzWgySBCDiOHdiEUABdG5j9CG9ZJ1Ez9OaR1f1unfyP8ZhwGq_FHhT0-pjPBrXjJsWoBQ/exec", 
      "2": "https://script.google.com/macros/s/AKfycbwxnLPRQIJeaMaVKkckre6j3XTXCow6HAOkn0g5mPC2ktVmxZelkOGxrG8j3N3n38TQ/exec", 
      "3": "https://script.google.com/macros/s/AKfycbzoDbEF93MRI6bC_NI1jIrhNAdIjnHvuriAtQy3XAFrPkuRTE5HGgQaa1IuHIbo6tqEwA/exec"
    };

    const MAX_SCORE = 10;
    let currentUser = null, activeApiUrl = "", heatData = [];

    window.onload = function() { checkSystemHealth(); };

    function checkSystemHealth() {
      fetch(GIST_URL + "?t=" + Date.now()).then(r=>updateStatus('auth',r.ok)).catch(()=>updateStatus('auth',false));
      Object.keys(API_POOL).forEach(k => fetch(API_POOL[k]+"?action=ping",{mode:'no-cors'}).then(()=>updateStatus('n'+k,true)).catch(()=>updateStatus('n'+k,false)));
    }
    function updateStatus(id, ok) { const el = document.getElementById(`stat-${id}`); if(el) el.className = ok ? 'status-dot dot-green':'status-dot dot-red'; }

    function handleLogin() {
      const u = document.getElementById('user').value.trim(), p = document.getElementById('pin').value.trim();
      if(!u || !p) return alert("Please enter your credentials.");
      showLoad("Verifying Identity...");
      
      fetch(GIST_URL + "?t=" + Date.now()).then(r=>r.json()).then(db => {
        const m = db.find(x => x.user === u && x.pin === p);
        if(m) {
          currentUser = m; activeApiUrl = API_POOL[m.num];
          document.getElementById('judge-lbl').innerText = m.name;
          document.getElementById('header-avatar').src = `https://ui-avatars.com/api/?name=${m.name}&background=ea580c&color=ffffff&rounded=true&size=64`;
          document.getElementById('active-node-lbl').innerText = "Node " + m.num;
          document.getElementById('status-panel').style.display = 'none';
          hideLoad(); switchScreen('track-screen');
        } else { 
          hideLoad(); 
          document.getElementById('login-error').innerText = "Incorrect Username or PIN."; 
          document.getElementById('login-error').style.display = 'block'; 
        }
      }).catch(() => { hideLoad(); alert("Network Error: Unable to verify login."); });
    }

    function startHeat() {
      const t = ['a','b','c'].map(x => document.getElementById('track-'+x).value.trim().toUpperCase()).filter(Boolean);
      if(!t.length) return alert("Please enter at least one track number.");
      showLoad("Fetching Contestants...");
      
      fetch(`${activeApiUrl}?action=getStudents&tracks=${t.join(',')}`)
        .then(r => r.json())
        .then(res => {
          hideLoad();
          if(res.status === 'success') {
            heatData = t.map((id, i) => ({
              uid: ['A','B','C'][i], track: id,
              info: res.data[id] || {name:'Unknown ID', group:'-', coach:'-'},
              scores: {a1:'', a2:'', a3:'', opt:''}
            }));
            renderGrid(); switchScreen('scoring-screen');
          } else { alert(res.message); }
        })
        .catch(() => { hideLoad(); alert("Failed to fetch data. Check your connection."); });
    }

    function renderGrid() {
      const g = document.getElementById('grid'); g.innerHTML = '';
      heatData.forEach((s, i) => {
        g.innerHTML += `
        <div class="score-card">
          <div class="student-details">
            <div class="sd-track">#${s.track}</div>
            <div class="sd-name" title="${s.info.name}">${s.info.name}</div>
            <div class="sd-coach">${s.info.coach}</div>
          </div>
          ${renderInp(i, 'a1', 'Asana 1')} ${renderInp(i, 'a2', 'Asana 2')}
          ${renderInp(i, 'a3', 'Asana 3')} ${renderInp(i, 'opt', 'Optional')}
        </div>`;
      });
    }

    function renderInp(idx, k, l) {
      return `<div class="input-cell">
        <span class="mobile-label">${l}</span>
        <input type="number" class="score-input" placeholder="-" oninput="val(this,${idx},'${k}')">
      </div>`;
    }

    function val(el, i, k) {
      const v = parseFloat(el.value);
      heatData[i].scores[k] = el.value;
      el.classList.remove('error');
      if(v > MAX_SCORE) el.classList.add('error');
    }

    function submit() {
      let crit = false, empty = false;
      heatData.forEach(s => ['a1','a2','a3','opt'].forEach(k => {
        const v = parseFloat(s.scores[k]);
        if(!isNaN(v) && v > MAX_SCORE) crit = true;
        if(s.scores[k] === '') empty = true;
      }));
      
      if(crit) return alert("One or more scores exceed the maximum limit (" + MAX_SCORE + "). Please correct them.");
      if(empty && !confirm("Warning: Some score fields are empty. Submit anyway?")) return;

      const payload = {
        judgeNum: currentUser.num,
        students: heatData.map(s => ({
          trackNo: s.track,
          scores: {
            a1: s.scores.a1===''?0:s.scores.a1, a2: s.scores.a2===''?0:s.scores.a2,
            a3: s.scores.a3===''?0:s.scores.a3, opt: s.scores.opt===''?0:s.scores.opt
          }
        }))
      };
      
      showLoad("Submitting Scores...");
      fetch(activeApiUrl, { method:"POST", body:JSON.stringify(payload) })
        .then(r => r.json())
        .then(d => { hideLoad(); if(d.status==='success') { alert("Scores Submitted Successfully!"); reset(); } else alert("Error: " + d.message); })
        .catch(() => { hideLoad(); alert("Submission failed. Please try again."); });
    }

    function showLoad(m) { document.getElementById('loader').classList.remove('hidden'); document.getElementById('loader-txt').innerText=m; }
    function hideLoad() { document.getElementById('loader').classList.add('hidden'); }
    function switchScreen(id) { 
      ['login-screen','track-screen','scoring-screen'].forEach(x => document.getElementById(x).classList.add('hidden')); 
      document.getElementById('app-header').classList.remove('hidden'); 
      document.getElementById(id).classList.remove('hidden'); 
    }
    function reset() { 
      ['track-a','track-b','track-c'].forEach(x => document.getElementById(x).value=''); 
      document.getElementById('scoring-screen').classList.add('hidden'); 
      document.getElementById('track-screen').classList.remove('hidden'); 
    }
    function toggleDropdown() { document.getElementById("userDropdown").classList.toggle("show"); }
    
    // Close dropdown on outside click
    window.onclick = function(e) { if (!e.target.closest('.user-menu')) { 
      document.getElementById("userDropdown").classList.remove('show'); 
    }}
  </script>
</body>
</html>