<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yoga Competition Live System</title>
    <style>
        :root {
            --primary: #4338ca;      /* Indigo 700 */
            --primary-light: #6366f1; /* Indigo 500 */
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            
            /* Rank Colors */
            --gold: #f59e0b;
            --silver: #94a3b8;
            --bronze: #b45309;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }

        /* --- HEADER & CONTROLS --- */
        .top-bar {
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .app-title h1 { margin: 0; font-size: 1.4rem; color: var(--primary); }
        .app-title small { font-size: 0.8rem; color: var(--text-sub); }

        .controls { display: flex; gap: 10px; align-items: center; }

        /* Live Pulse Button */
        .live-btn {
            display: flex; align-items: center; gap: 8px;
            background: #e2e8f0; padding: 8px 16px; border-radius: 20px;
            cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.3s;
            border: 1px solid transparent;
        }
        .live-btn.active { background: #dcfce7; color: #166534; border-color: #86efac; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #64748b; }
        .live-btn.active .dot { background: #22c55e; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* Tabs */
        .tabs { background: #f1f5f9; padding: 4px; border-radius: 8px; display: flex; gap: 4px; }
        .tab {
            padding: 8px 16px; border: none; background: none; border-radius: 6px;
            cursor: pointer; font-weight: 600; color: var(--text-sub); transition: 0.2s;
        }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* Filter Chips */
        .filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; }
        .chip {
            background: white; border: 1px solid var(--border); padding: 5px 12px;
            border-radius: 15px; font-size: 0.85rem; cursor: pointer; white-space: nowrap;
        }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- VIEWS --- */
        .view { display: none; }
        .view.active { display: block; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- LIVE TABLE --- */
        .class-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .class-header { padding: 15px; background: #f8fafc; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--primary); font-size: 1.1rem; }
        
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f1f5f9; padding: 12px 8px; text-align: center; border-bottom: 2px solid var(--border); color: var(--text-main); white-space: nowrap; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; vertical-align: middle; }
        
        /* Fixed First Column */
        .col-fixed { position: sticky; left: 0; background: white; z-index: 10; text-align: left; border-right: 2px solid #f1f5f9; min-width: 150px; }
        th.col-fixed { background: #f1f5f9; z-index: 20; }
        
        /* Specific Columns */
        .col-score-group { border-right: 1px solid var(--border); }
        .score-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px; width: 75px; margin: 0 auto; }
        .sv { background: #f3f4f6; border-radius: 3px; font-size: 0.75rem; color: #64748b; padding: 1px 0; }
        
        .val-judge { font-weight: 600; color: #4b5563; background: #f9fafb; padding: 3px 6px; border-radius: 4px; }
        .val-total { font-weight: 800; color: var(--primary); font-size: 1rem; }
        .val-perc { background: #e0e7ff; color: #3730a3; padding: 3px 8px; border-radius: 10px; font-weight: 700; font-size: 0.8rem; }

        /* --- PODIUM JUDGMENT --- */
        .podium-area { display: flex; justify-content: center; align-items: flex-end; height: 280px; gap: 15px; margin: 30px auto; max-width: 600px; }
        .podium-col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        
        .p-bar { width: 100%; border-radius: 8px 8px 0 0; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; color: white; font-weight: bold; font-size: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .p-1 { height: 180px; background: linear-gradient(to bottom, #fcd34d, #d97706); }
        .p-2 { height: 140px; background: linear-gradient(to bottom, #cbd5e1, #64748b); }
        .p-3 { height: 100px; background: linear-gradient(to bottom, #fdba74, #b45309); }
        
        .winner-tag { background: white; padding: 8px; border-radius: 6px; text-align: center; margin-bottom: 10px; width: 110%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .w-name { font-weight: 700; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .w-score { color: var(--primary); font-weight: 800; }

        .rank-list { max-width: 900px; margin: 0 auto; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .rank-item { display: grid; grid-template-columns: 50px 1fr 100px 180px; align-items: center; padding: 12px; border-bottom: 1px solid #f1f5f9; background: white; }
        .rank-item:last-child { border-bottom: none; }
        .rank-head { background: #f8fafc; font-weight: 600; color: var(--text-sub); font-size: 0.85rem; }
        
        .tie-reason { font-size: 0.75rem; color: #d97706; background: #fffbeb; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
        .judge-breakdown { font-size: 0.75rem; color: var(--text-sub); margin-top: 2px; }

        /* Loader */
        .toast { position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: white; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 999; }
        .toast.show { opacity: 1; bottom: 30px; }

    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <div class="app-title">
            <h1>üèÜ Yoga Scoreboard</h1>
            <small id="lastUpdated">Waiting for data...</small>
        </div>
        
        <div class="controls">
            <div id="liveToggle" class="live-btn" onclick="toggleLive()">
                <div class="dot"></div>
                <span id="liveText">Paused</span>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="setTab('live', this)">üìù Live Sheet</button>
                <button class="tab" onclick="setTab('judgement', this)">üèÜ Judgment</button>
            </div>
            
            <button onclick="fetchData()" style="padding: 8px 12px; background: var(--text-main); color: white; border: none; border-radius: 6px; cursor: pointer;">
                Refresh
            </button>
        </div>
    </div>

    <div id="filterBar" class="filters"></div>

    <div id="view-live" class="view active"></div>

    <div id="view-judgement" class="view"></div>
</div>

<div id="toast" class="toast">Updated successfully</div>

<script>
    /* ================= SETUP ================= */
    // 1. YOUR SHEET LINK
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRksQprL7ZPKGWsYvETJrbrlG-lDSN3jW0SEWt90CB7g69mYFPpHqa0Z9WjrH03Hy5xCUFeMjlJHI5-/pub?output=csv";

    // 2. SCORING CONFIG
    const MARKS_PER_ASANA = 25; // Change if marks are out of 10, 20 etc.
    const NUM_JUDGES = 3;
    const NUM_ASANAS = 4; // 3 Main + 1 Optional
    const TOTAL_FM = MARKS_PER_ASANA * NUM_ASANAS * NUM_JUDGES; // Auto-calculated (300)

    const COLS = {
        id: "Roll No",
        name: "Name of the Student",
        cls: "Class",
        asanas: [
            { name: "Asana 1", keys: ["ASANA 1 (Judge 1)", "ASANA 1 (Judge 2)", "ASANA 1 (Judge 3)"] },
            { name: "Asana 2", keys: ["ASANA 2 (Judge 1)", "ASANA 2 (Judge 2)", "ASANA 2 (Judge 3)"] },
            { name: "Asana 3", keys: ["ASANA 3 (Judge 1)", "ASANA 3 (Judge 2)", "ASANA 3 (Judge 3)"] },
            { name: "Optional", keys: ["OPTIONAL (Judge 1)", "OPTIONAL (Judge 2)", "OPTIONAL (Judge 3)"] }
        ],
        // Columns needed for Judge Totals
        j1: ["ASANA 1 (Judge 1)", "ASANA 2 (Judge 1)", "ASANA 3 (Judge 1)", "OPTIONAL (Judge 1)"],
        j2: ["ASANA 1 (Judge 2)", "ASANA 2 (Judge 2)", "ASANA 3 (Judge 2)", "OPTIONAL (Judge 2)"],
        j3: ["ASANA 1 (Judge 3)", "ASANA 2 (Judge 3)", "ASANA 3 (Judge 3)", "OPTIONAL (Judge 3)"]
    };

    /* ================= STATE ================= */
    let rawData = [];
    let activeClass = "All";
    let isLive = false;
    let timer = null;

    /* ================= CORE FUNCTIONS ================= */
    
    // Toggle Live Mode
    function toggleLive() {
        isLive = !isLive;
        const btn = document.getElementById('liveToggle');
        const txt = document.getElementById('liveText');
        
        if (isLive) {
            btn.classList.add('active');
            txt.innerText = "Live (Auto)";
            fetchData();
            timer = setInterval(fetchData, 5000); // 5 Seconds
            alert("Live Mode On: App will check for updates every 5 seconds.\n\nNOTE: Google Sheets takes 3-5 minutes to publish changes to the web.");
        } else {
            btn.classList.remove('active');
            txt.innerText = "Paused";
            clearInterval(timer);
        }
    }

    // Tab Switcher
    function setTab(viewId, btnEl) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active');
        btnEl.classList.add('active');
    }

    // Data Fetcher
    async function fetchData() {
        try {
            // Add timestamp to URL to bypass browser cache
            const url = `${CSV_URL}&t=${Date.now()}`; 
            const res = await fetch(url);
            const text = await res.text();
            
            processData(text);
            
            const now = new Date();
            document.getElementById('lastUpdated').innerText = `Updated: ${now.toLocaleTimeString()}`;
            showToast();
        } catch (err) {
            console.error(err);
            document.getElementById('lastUpdated').innerText = `Error fetching data`;
        }
    }

    function showToast() {
        const t = document.getElementById('toast');
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // CSV Parser with Header Trimming
    function processData(csv) {
        const lines = csv.split("\n").filter(l => l.trim() !== "");
        const headers = lines[0].split(",").map(h => h.trim().replace(/^"|"$/g, '')); // Trim headers!
        
        rawData = [];
        const classes = new Set();

        for (let i = 1; i < lines.length; i++) {
            // Regex handles quoted commas correctly
            const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, ''));
            const obj = {};
            headers.forEach((h, idx) => obj[h] = row[idx]);

            // Calculate Scores
            const j1Sum = getSum(obj, COLS.j1);
            const j2Sum = getSum(obj, COLS.j2);
            const j3Sum = getSum(obj, COLS.j3);
            const grand = j1Sum + j2Sum + j3Sum;
            const perc = ((grand / TOTAL_FM) * 100).toFixed(2);
            
            const cls = obj[COLS.cls] ? obj[COLS.cls].trim() : "Unknown";
            classes.add(cls);

            rawData.push({
                ...obj,
                j1Sum, j2Sum, j3Sum, grand, perc, cls
            });
        }

        renderFilters(Array.from(classes).sort());
        renderApp();
    }

    function getSum(row, keys) {
        return keys.reduce((sum, k) => {
            const val = parseFloat(row[k]);
            return sum + (isNaN(val) ? 0 : val);
        }, 0);
    }

    /* ================= RENDERING ================= */

    function renderFilters(classList) {
        const bar = document.getElementById('filterBar');
        if (bar.innerHTML !== "") return; // Don't redraw if exists

        let html = `<div class="chip active" onclick="setFilter('All', this)">All Classes</div>`;
        classList.forEach(c => {
            html += `<div class="chip" onclick="setFilter('${c}', this)">${c}</div>`;
        });
        bar.innerHTML = html;
    }

    function setFilter(cls, el) {
        activeClass = cls;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        renderApp();
    }

    function renderApp() {
        // Filter Data
        const data = activeClass === "All" ? rawData : rawData.filter(d => d.cls === activeClass);
        
        // Group by Class
        const grouped = {};
        const cats = activeClass === "All" ? [...new Set(data.map(d => d.cls))].sort() : [activeClass];
        cats.forEach(c => grouped[c] = data.filter(d => d.cls === c));

        // Render Views
        renderLiveTable(grouped);
        renderJudgement(grouped);
    }

    // --- VIEW 1: LIVE TABLE ---
    function renderLiveTable(grouped) {
        const cont = document.getElementById('view-live');
        cont.innerHTML = "";

        Object.keys(grouped).forEach(cls => {
            const students = grouped[cls];
            if (!students.length) return;

            let rows = "";
            students.forEach(s => {
                // Build Asana Scores
                let asanaHtml = "";
                COLS.asanas.forEach(a => {
                    asanaHtml += `
                        <td class="col-score-group">
                            <div class="score-row">
                                <span class="sv">${s[a.keys[0]] || '-'}</span>
                                <span class="sv">${s[a.keys[1]] || '-'}</span>
                                <span class="sv">${s[a.keys[2]] || '-'}</span>
                            </div>
                        </td>`;
                });

                rows += `
                    <tr>
                        <td class="col-fixed">
                            <div style="font-weight:600;">${s[COLS.name]}</div>
                            <div style="font-size:0.75rem; color:#6b7280;">Roll: ${s[COLS.id]}</div>
                        </td>
                        ${asanaHtml}
                        <td><span class="val-judge">${s.j1Sum}</span></td>
                        <td><span class="val-judge">${s.j2Sum}</span></td>
                        <td><span class="val-judge">${s.j3Sum}</span></td>
                        <td><span class="val-total">${s.grand}</span></td>
                        <td><span class="val-perc">${s.perc}%</span></td>
                    </tr>
                `;
            });

            // Headers
            let asanaHeads = COLS.asanas.map(a => `<th>${a.name}<br><span style="font-size:0.7em; font-weight:400; color:#6b7280">(J1|J2|J3)</span></th>`).join("");

            cont.innerHTML += `
                <div class="class-card">
                    <div class="class-header">${cls}</div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th class="col-fixed">Student</th>
                                    ${asanaHeads}
                                    <th>J1<br>Total</th>
                                    <th>J2<br>Total</th>
                                    <th>J3<br>Total</th>
                                    <th>Grand<br>Total</th>
                                    <th>%</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        });
    }

    // --- VIEW 2: JUDGMENT ---
    function renderJudgement(grouped) {
        const cont = document.getElementById('view-judgement');
        cont.innerHTML = "";

        Object.keys(grouped).forEach(cls => {
            // SORTING RULES (Transparency Logic)
            const students = [...grouped[cls]].sort((a, b) => {
                if (b.grand !== a.grand) return b.grand - a.grand; // Rule 1
                if (b.j1Sum !== a.j1Sum) return b.j1Sum - a.j1Sum; // Rule 2
                return b.j2Sum - a.j2Sum; // Rule 3
            });

            if (!students.length) return;

            // Podium Setup
            const [s1, s2, s3] = students;
            
            let podiumHtml = `
                <div class="podium-area">
                    <div class="podium-col" style="order:1">
                        ${s2 ? `<div class="winner-tag"><div class="w-name">${s2[COLS.name]}</div><div class="w-score">${s2.grand}</div></div><div class="p-bar p-2">2</div>` : ''}
                    </div>
                    <div class="podium-col" style="order:2">
                        ${s1 ? `<div class="winner-tag" style="transform:scale(1.1); border:2px solid var(--gold);"><div class="w-name">${s1[COLS.name]}</div><div class="w-score">${s1.grand}</div></div><div class="p-bar p-1">1</div>` : ''}
                    </div>
                    <div class="podium-col" style="order:3">
                        ${s3 ? `<div class="winner-tag"><div class="w-name">${s3[COLS.name]}</div><div class="w-score">${s3.grand}</div></div><div class="p-bar p-3">3</div>` : ''}
                    </div>
                </div>
            `;

            // List Setup
            let listHtml = `
                <div class="rank-list">
                    <div class="rank-item rank-head">
                        <div>#</div>
                        <div>Student Name</div>
                        <div>Total</div>
                        <div>Rule Transparency</div>
                    </div>
            `;

            students.forEach((s, idx) => {
                // Determine Tie Reason for transparency
                let tieInfo = "";
                const prev = students[idx-1];
                if (prev && prev.grand === s.grand) {
                    if (prev.j1Sum > s.j1Sum) tieInfo = `<span class="tie-reason">Lost Tie: Judge 1 (${s.j1Sum} vs ${prev.j1Sum})</span>`;
                    else if (prev.j2Sum > s.j2Sum) tieInfo = `<span class="tie-reason">Lost Tie: Judge 2 (${s.j2Sum} vs ${prev.j2Sum})</span>`;
                    else tieInfo = `<span class="tie-reason" style="background:#f3f4f6; color:#6b7280;">Perfect Tie</span>`;
                }

                listHtml += `
                    <div class="rank-item">
                        <div style="font-weight:700; color:#cbd5e1; font-size:1.2rem;">${idx+1}</div>
                        <div>
                            <div style="font-weight:600;">${s[COLS.name]}</div>
                            <div class="judge-breakdown">J1:${s.j1Sum} | J2:${s.j2Sum} | J3:${s.j3Sum}</div>
                        </div>
                        <div style="font-weight:700; color:var(--primary); font-size:1.1rem;">${s.grand}</div>
                        <div>${tieInfo}</div>
                    </div>
                `;
            });
            listHtml += `</div>`;

            cont.innerHTML += `
                <div class="class-card">
                    <div class="class-header">${cls} - Final Results</div>
                    ${podiumHtml}
                    ${listHtml}
                </div>
            `;
        });
    }

    // Init
    fetchData();

</script>
</body>
</html>