<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOGA PRO 2026</title>
    <style>
        :root {
            --primary: #ea580c; --dark: #c2410c; --bg: #fff7ed; --surface: #ffffff;
            --text: #1f2937; --gray: #6b7280;
            --gold: #f59e0b; --silver: #64748b; --bronze: #b45309;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; min-height: 100vh; }
        
        /* HEADER */
        header { background: var(--surface); padding: 15px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-bottom: 4px solid var(--primary); margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--primary); }
        .brand h1 { margin: 0; font-size: 1.5rem; color: var(--dark); text-transform: uppercase; }
        
        .judges-panel { display: flex; gap: 10px; background: #fff; padding: 5px 15px; border-radius: 50px; border: 1px solid #fed7aa; }
        .judge-item { text-align: center; padding: 0 10px; border-right: 1px solid #ddd; }
        .judge-item:last-child { border: none; }
        .judge-lbl { font-size: 0.7rem; color: var(--gray); font-weight: bold; display: block; }
        .judge-val { font-weight: 700; font-size: 0.9rem; }

        /* CONTROLS */
        .toolbar { position: sticky; top: 10px; z-index: 100; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; gap: 10px; flex-wrap: wrap; align-items: center; border: 1px solid #e5e7eb; }
        
        .tabs { display: flex; background: #f3f4f6; padding: 4px; border-radius: 8px; }
        .tab { border: none; background: none; padding: 8px 16px; font-weight: 600; cursor: pointer; border-radius: 6px; color: var(--gray); }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .search-box { display: flex; border: 1px solid #d1d5db; border-radius: 8px; overflow: hidden; background: white; flex-grow: 1; max-width: 400px; }
        .search-type { border: none; background: #f9fafb; padding: 0 10px; font-weight: 600; border-right: 1px solid #ddd; cursor: pointer; }
        .search-in { border: none; padding: 8px; width: 100%; outline: none; }
        .btn-apply { background: var(--primary); color: white; border: none; padding: 0 15px; font-weight: 700; cursor: pointer; }
        
        .sugg-list { position: absolute; background: white; border: 1px solid #ddd; width: 300px; max-height: 200px; overflow-y: auto; display: none; z-index: 200; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 45px; }
        .sugg-opt { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
        .sugg-opt:hover { background: #fff7ed; }

        .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn:hover { background: #f9fafb; }
        .btn-live { background: #ecfccb; color: #365314; border-color: #bef264; }
        .btn-live.on { background: #22c55e; color: white; }
        
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; border: 1px solid #e5e7eb; }
        .card-head { background: #fff7ed; padding: 10px 15px; font-weight: 700; color: var(--dark); border-bottom: 1px solid #fed7aa; display: flex; justify-content: space-between; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f9fafb; padding: 10px; text-align: center; color: var(--gray); font-size: 0.75rem; border-bottom: 2px solid #e5e7eb; }
        td { padding: 8px; text-align: center; border-bottom: 1px solid #f3f4f6; }
        
        .col-left { text-align: left; padding-left: 15px; border-right: 2px solid #eee; width: 250px; }
        .s-id { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .s-name { display: block; font-weight: 700; font-size: 1rem; color: var(--text); }
        .s-coach { font-size: 0.8rem; color: var(--primary); }
        
        .sc-box { background: #fff; border: 1px solid #ddd; padding: 4px; border-radius: 4px; font-weight: bold; font-family: monospace; display: inline-block; width: 30px; margin: 0 1px; }
        .sc-j1 { border-color: #fed7aa; background: #fff7ed; color: #9a3412; }
        .sc-j2 { border-color: #bfdbfe; background: #eff6ff; color: #1e40af; }
        .sc-j3 { border-color: #bbf7d0; background: #f0fdf4; color: #166534; }
        
        .grand { background: var(--primary); color: white; padding: 4px 10px; border-radius: 6px; font-weight: 900; }

        /* PODIUM */
        .podium { display: flex; align-items: flex-end; justify-content: center; height: 350px; gap: 15px; padding: 20px; }
        .p-col { flex: 1; max-width: 250px; text-align: center; display: flex; flex-direction: column; justify-content: flex-end; }
        .winner { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 1px solid #eee; margin-bottom: 10px; position: relative; }
        .w-rank { font-size: 3rem; font-weight: 900; color: rgba(0,0,0,0.1); position: absolute; top: 0; right: 10px; line-height: 1; }
        .w-score { font-size: 1.8rem; font-weight: 900; color: var(--primary); }
        .bar { width: 100%; border-radius: 8px 8px 0 0; color: white; font-weight: 900; font-size: 2rem; padding-bottom: 10px; display: flex; justify-content: center; align-items: flex-end; }
        
        .p1 .bar { height: 200px; background: var(--gold); } .p1 .winner { border: 2px solid var(--gold); transform: scale(1.1); z-index: 2; }
        .p2 .bar { height: 150px; background: var(--silver); } .p2 .winner { border: 2px solid var(--silver); }
        .p3 .bar { height: 100px; background: var(--bronze); } .p3 .winner { border: 2px solid var(--bronze); }

        @media print {
            body { background: white; padding: 0; }
            header, .toolbar, footer { display: none !important; }
            .section { display: block !important; }
            .card { box-shadow: none; border: 1px solid #000; break-inside: avoid; }
            .card-head { background: #eee !important; color: black !important; border-bottom: 1px solid #000; }
            
            body.print-list .score-col, body.print-list .grand-col { display: none !important; }
            body.print-list .col-left { width: 100%; border: none; }
            body.print-list .sc-box { display: none; }
            
            body.print-report .sc-box { border: none !important; background: none !important; color: black !important; }
            body.print-report .grand { background: none !important; color: black !important; border: 2px solid black; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand">
            <img src="resources/yoga_dp.jpeg" onerror="this.style.display='none'">
            <div>
                <h1>YOGA PRO</h1>
                <small>Championship Management System</small>
            </div>
        </div>
        <div class="judges-panel">
            <div class="judge-item"><span class="judge-lbl">J1</span><span class="judge-val" id="j1">...</span></div>
            <div class="judge-item"><span class="judge-lbl">J2</span><span class="judge-val" id="j2">...</span></div>
            <div class="judge-item"><span class="judge-lbl">J3</span><span class="judge-val" id="j3">...</span></div>
        </div>
    </header>

    <div class="toolbar">
        <div class="tabs">
            <button class="tab active" onclick="setTab('live', this)">Live Scores</button>
            <button class="tab" onclick="setTab('judgment', this)">Judgment</button>
        </div>

        <div class="search-box">
            <select class="search-type" id="filterType">
                <option value="coach">Coach</option>
                <option value="track">Track No</option>
            </select>
            <input type="text" class="search-in" id="filterIn" placeholder="Type to search..." onkeyup="showSugg(this.value)">
            <button class="btn-apply" onclick="applyFilter()">Apply</button>
        </div>
        <div id="suggList" class="sugg-list"></div>

        <button class="btn" onclick="fetchCandidates(true)">üîÑ Candidates</button>
        <button class="btn" onclick="fetchMarks(true)">üîÑ Marks</button>
        <button class="btn btn-live" id="btnLive" onclick="toggleLive()">üî¥ <span id="txtLive">OFFLINE</span></button>
        
        <div style="margin-left:auto; display:flex; gap:5px;">
            <button class="btn btn-print" onclick="printPage('report')">üñ®Ô∏è Report</button>
            <button class="btn" onclick="printPage('list')">üìã List</button>
        </div>
    </div>

    <div id="view-live" class="section active"></div>

    <div id="view-judgment" class="section"></div>
</div>

<footer style="text-align:center; padding:20px; font-size:0.8rem; color:#888;">
    www.soumenyoga.in | Powered by BAHA Interactive
</footer>

<script>
    // --- CONFIGURATION ---
    const STATIC_API = "https://script.google.com/macros/s/AKfycbxtZybHhdGDowz6esQvOxr10Gr9ZHvyTGzLVlOO6WBU_kjaNbev9QMUSDxmSSzanjidqw/exec"; 
    const DYNAMIC_API = "https://script.google.com/macros/s/AKfycbzGX1rXMwOUaX1zi74bpqUU5kN1It0GzWwzwUuU2oZDVh94Rgxjp64PKhz1ssNvKG2nAg/exec";
    
    // DIRECT DRIVE LINK (Note: If this fails due to CORS, use fallback below)
    const JUDGE_LINK = "https://drive.google.com/uc?export=download&id=1LRffTqzOgQwnBAwFqt1dSa-UmT7r1gzx";

    // --- STATE ---
    let students = [], marks = {}, divisions = {};
    let coachList = new Set();
    let isLive = false, liveTimer = null;
    let activeFilter = { type: 'none', val: '' };

    window.onload = () => {
        fetchJudges();
        fetchCandidates();
        document.addEventListener('click', e => {
            if (!e.target.closest('.search-box')) document.getElementById('suggList').style.display = 'none';
        });
    };

    // --- 1. FETCHING ---
    async function fetchJudges() {
        try {
            const res = await fetch(JUDGE_LINK);
            const d = await res.json();
            renderJudges(d);
        } catch (e) {
            console.warn("Direct Drive Fetch Failed (CORS). Using Fallback.");
            // FALLBACK DATA (Uncomment if needed)
            
            const d = [
              { "name": "Gourab Tripathi", "num": "1" },
              { "name": "Bidisha Dey", "num": "2" },
              { "name": "Deep Jana", "num": "3" }
            ];
            renderJudges(d);
            
        }
    }

    function renderJudges(d) {
        const j1 = d.find(x => String(x.num) === "1");
        const j2 = d.find(x => String(x.num) === "2");
        const j3 = d.find(x => String(x.num) === "3");
        document.getElementById('j1').innerText = j1?.name || "-";
        document.getElementById('j2').innerText = j2?.name || "-";
        document.getElementById('j3').innerText = j3?.name || "-";
    }

    async function fetchCandidates(manual=false) {
        try {
            const res = await fetch(`${STATIC_API}?type=students`);
            students = await res.json();
            coachList.clear();
            students.forEach(s => { if(s["COACH NAME"]) coachList.add(s["COACH NAME"]); });
            processData(); 
            if(manual) alert("Candidates Refreshed!");
            fetchMarks();
        } catch(e) { console.error(e); }
    }

    async function fetchMarks(manual=false) {
        try {
            const res = await fetch(DYNAMIC_API);
            const data = await res.json();
            marks = {};
            data.forEach(row => {
                const id = row["TRACK NO"];
                if(id) marks[id] = row;
            });
            updateValues(); 
            if(manual) alert("Marks Updated!");
        } catch(e) { console.error(e); }
    }

    // --- 2. LOGIC ---
    function processData() {
        divisions = {};
        let buckets = {};
        students.forEach(s => {
            const key = `${s.GROUP} - ${s.SEX}`;
            if(!buckets[key]) buckets[key] = [];
            buckets[key].push(s);
        });

        Object.keys(buckets).forEach(k => {
            const sorted = roundRobinSort(buckets[k]);
            for(let i=0; i<sorted.length; i+=10) {
                const divName = `${k} - Division ${String.fromCharCode(65 + (i/10))}`;
                divisions[divName] = sorted.slice(i, i+10);
            }
        });
        renderAll();
    }

    function roundRobinSort(list) {
        let coaches = {};
        list.forEach(s => {
            const c = s["COACH NAME"] || "Unk";
            if(!coaches[c]) coaches[c] = [];
            coaches[c].push(s);
        });
        let res = [], keys = Object.keys(coaches);
        let max = Math.max(...Object.values(coaches).map(a=>a.length));
        for(let i=0; i<max; i++) {
            keys.forEach(k => { if(coaches[k][i]) res.push(coaches[k][i]); });
        }
        return res;
    }

    // --- 3. RENDERING ---
    function renderAll() {
        const live = document.getElementById('view-live');
        const judge = document.getElementById('view-judgment');
        live.innerHTML = ""; judge.innerHTML = "";

        Object.keys(divisions).sort().forEach(divName => {
            const athletes = divisions[divName];
            let visibleCount = 0;

            let rows = athletes.map(s => {
                const id = s["TRACK NO"];
                let show = true;
                if (activeFilter.type === 'coach' && activeFilter.val && !s["COACH NAME"].toLowerCase().includes(activeFilter.val)) show = false;
                if (activeFilter.type === 'track' && activeFilter.val && String(id).toLowerCase() !== activeFilter.val) show = false;
                
                if(show) visibleCount++;
                const displayStyle = show ? '' : 'display:none;';

                return `<tr style="${displayStyle}">
                    <td class="col-left">
                        <span class="s-id">${id}</span>
                        <span class="s-name">${s["NAME OF THE ATHLETES"]}</span>
                        <span class="s-coach">${s["COACH NAME"]}</span>
                        <div style="font-size:0.8rem; color:#666;">Age: ${s["AGE"]} | ${s["CENTER NAME"]}</div>
                    </td>
                    ${cols(id, 1)} ${cols(id, 2)} ${cols(id, 3)} ${cols(id, "OPTIONAL")}
                    <td class="score-col tot" id="t-${id}-1">-</td>
                    <td class="score-col tot" id="t-${id}-2">-</td>
                    <td class="score-col tot" id="t-${id}-3">-</td>
                    <td class="grand-col"><span class="grand" id="t-${id}-all">-</span></td>
                </tr>`;
            }).join('');

            if (visibleCount > 0 || activeFilter.type === 'none') {
                live.innerHTML += `
                    <div class="card">
                        <div class="card-head"><span>${divName}</span><span>${visibleCount} Athletes</span></div>
                        <div style="overflow-x:auto"><table>
                            <thead><tr>
                                <th class="col-left">Athlete Details</th>
                                <th class="score-col">Asana 1</th><th class="score-col">Asana 2</th><th class="score-col">Asana 3</th><th class="score-col">Opt</th>
                                <th class="score-col">J1</th><th class="score-col">J2</th><th class="score-col">J3</th><th class="grand-col">Total</th>
                            </tr></thead>
                            <tbody>${rows}</tbody>
                        </table></div>
                    </div>`;
                
                judge.innerHTML += `<div id="podium-${divName.replace(/[^a-zA-Z0-9]/g,'')}"></div>`;
            }
        });
    }

    function cols(id, n) {
        let l = n==="OPTIONAL"?"O":`A${n}`;
        return `<td class="score-col">
            <span class="sc-box sc-j1" id="s-${id}-${l}-1">-</span>
            <span class="sc-box sc-j2" id="s-${id}-${l}-2">-</span>
            <span class="sc-box sc-j3" id="s-${id}-${l}-3">-</span>
        </td>`;
    }

    // --- 4. UPDATES ---
    function updateValues() {
        Object.keys(divisions).forEach(divName => {
            const athletes = divisions[divName];
            athletes.forEach(s => {
                const id = s["TRACK NO"];
                const sc = marks[id] || {};
                let t1=0, t2=0, t3=0;

                [1,2,3,"OPTIONAL"].forEach(a => {
                    let l = a==="OPTIONAL"?"O":`A${a}`;
                    let k = a==="OPTIONAL"?"OPTIONAL":`ASANA ${a}`;
                    let v1=Number(sc[`${k} (Judge 1)`]||0), v2=Number(sc[`${k} (Judge 2)`]||0), v3=Number(sc[`${k} (Judge 3)`]||0);
                    setTxt(`s-${id}-${l}-1`, v1||'-'); setTxt(`s-${id}-${l}-2`, v2||'-'); setTxt(`s-${id}-${l}-3`, v3||'-');
                    t1+=v1; t2+=v2; t3+=v3;
                });

                setTxt(`t-${id}-1`, t1); setTxt(`t-${id}-2`, t2); setTxt(`t-${id}-3`, t3);
                let g = t1+t2+t3;
                setTxt(`t-${id}-all`, Math.round(g));
                s.score = { grand: g, j1: t1, j2: t2 };
            });
            renderPodium(divName, athletes);
        });
    }

    function setTxt(id, v) { const e = document.getElementById(id); if(e) e.innerText = v; }

    function renderPodium(divName, list) {
        let sorted = [...list].sort((a,b) => (b.score?.grand||0)-(a.score?.grand||0) || (b.score?.j1||0)-(a.score?.j1||0));
        let top3 = sorted.slice(0,3);
        let pid = divName.replace(/[^a-zA-Z0-9]/g,'');
        let div = document.getElementById(`podium-${pid}`);
        if(!div) return;

        div.innerHTML = `
            <div class="card">
                <div class="card-head">üèÜ ${divName} Results</div>
                <div class="podium">
                    <div class="p-col p2">${winHtml(top3[1], 2, 'silver')}</div>
                    <div class="p-col p1">${winHtml(top3[0], 1, 'gold')}</div>
                    <div class="p-col p3">${winHtml(top3[2], 3, 'bronze')}</div>
                </div>
            </div>`;
    }

    function winHtml(s, rank, color) {
        if(!s) return '';
        return `<div class="winner">
            <div class="w-rank">${rank}</div>
            <strong>${s["NAME OF THE ATHLETES"]}</strong><br>
            <small>${s["COACH NAME"]}</small>
            <div class="w-score">${Math.round(s.score?.grand||0)}</div>
        </div><div class="bar"></div>`;
    }

    // --- 5. SEARCH & UTILS ---
    function showSugg(val) {
        const type = document.getElementById('filterType').value;
        const box = document.getElementById('suggList');
        if(type !== 'coach' || val.length < 1) { box.style.display = 'none'; return; }
        
        const m = Array.from(coachList).filter(c => c.toLowerCase().includes(val.toLowerCase()));
        box.innerHTML = m.map(c => `<div class="sugg-opt" onclick="selSugg('${c}')">${c}</div>`).join('');
        box.style.display = m.length ? 'block' : 'none';
    }

    function selSugg(val) {
        document.getElementById('filterIn').value = val;
        document.getElementById('suggList').style.display = 'none';
    }

    function applyFilter() {
        activeFilter = {
            type: document.getElementById('filterType').value,
            val: document.getElementById('filterIn').value.toLowerCase()
        };
        renderAll();
    }

    function setTab(view, btn) {
        document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.add('active');
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function printPage(mode) {
        document.body.className = (mode === 'list') ? 'print-list' : 'print-report';
        window.print();
        document.body.className = '';
    }

    function toggleLive() {
        isLive = !isLive;
        const b = document.getElementById('btnLive');
        if(isLive) {
            b.classList.add('on'); document.getElementById('txtLive').innerText = "LIVE ON";
            liveTimer = setInterval(() => fetchMarks(), 30000);
        } else {
            b.classList.remove('on'); document.getElementById('txtLive').innerText = "OFFLINE";
            clearInterval(liveTimer);
        }
    }
</script>
</body>
</html>